@page "/Plan"
@using SuperApp_UI.Models
@inject HttpClient Http
@inject NavigationManager Navigation
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<div class="superplan-page">
    <h3 class="superplan-heading">Available Plans</h3>

    <div class="Planfeatures">
        @if (suscribedPlans != null)
        {
            var isExpired = suscribedPlans.EndDate <= DateTime.Now;

            @if (!isExpired)
            {
                <div class="superplan-subscribed">
                    <p style="color:antiquewhite">You already purchased a plan</p>

                    <div class="superplan-card p-4 shadow-sm">
                        <h4>@suscribedPlans.PlanName</h4>
                        <p><strong>Price:</strong> ₹@suscribedPlans.Cost</p>
                        <p><strong>Status:</strong> @suscribedPlans.Status</p>
                        <p><strong>Start Date:</strong> @suscribedPlans.StartDate.ToString("dd-MMM-yyyy hh:mm tt")</p>
                        <p><strong>End Date:</strong> @suscribedPlans.EndDate.ToString("dd-MMM-yyyy hh:mm tt")</p>
                        <p><strong>Validity:</strong> @suscribedPlans.Validity days</p>

                        @if (suscribedPlans?.Platforms != null && suscribedPlans.Platforms.Any())
                        {
                            <h5 class="mt-3">Included Platforms</h5>
                            <div class="superplan-platforms">
                                @foreach (var platform in suscribedPlans.Platforms)
                                {
                                    <a href="@platform.Url" target="_blank">
                                        <img src="@platform.ImageUrl" alt="@platform.Name" />
                                    </a>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="superplan-expired text-center mt-4">
                    <h4 class="text-danger">⚠️ Your subscription has expired!</h4>
                    <p>The plan <strong>@suscribedPlans.PlanName</strong> ended on <strong>@suscribedPlans.EndDate.ToString("dd-MMM-yyyy hh:mm tt")</strong>.</p>

                    <button class="btn btn-primary mt-3" @onclick="PurchaseNewPlan">Purchase New Plan</button>
                </div>
            }
        }
        else if (plans != null)
        {
            <div class="superplan-plans">
                @foreach (var plan in plans)
                {
                    var cardClass = plan.PlanName.Contains("Super", StringComparison.OrdinalIgnoreCase)
                    ? "superplan-card popular"
                    : "superplan-card";

                    <div class="@cardClass">
                        <h5>@plan.PlanName</h5>
                        <p>@plan.PlanDescription</p>
                        <p><strong>Price:</strong> ₹@plan.Cost</p>

                        @if (plan.Platforms != null && plan.Platforms.Any())
                        {
                            <div class="superplan-platforms">
                                @foreach (var platform in plan.Platforms)
                                {
                                    <img src="@platform.ImageUrl" alt="@platform.Name" />
                                }
                            </div>
                        }

                        <button @onclick="() => SelectPlan(plan)">Subscribe Now</button>
                    </div>
                }
            </div>
        }
        else
        {
            <p>Loading plans...</p>
        }


        @if (selectedPlan != null)
        {
            <div class="modal-overlay">
                <div class="modal-content animate-pop">
                    <h4 class="modal-title">🎉 You Selected a Plan!</h4>
                    <p class="plan-name">@selectedPlan.PlanName</p>
                    <p class="plan-price">💰 ₹@selectedPlan.Cost</p>

                    <div class="modal-buttons">
                        <button class="btn btn-success confirm-btn" @onclick="ConfirmSelection">Continue</button>
                        <button class="btn btn-secondary cancel-btn" @onclick="CancelSelection">Cancel</button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<PlanDTO>? plans;
    private PlanDTO? selectedPlan;
    [Parameter] public Guid Userid { get; set; }
    private SuscribedPlanDTO? suscribedPlans;

    protected override async Task OnInitializedAsync()
    {
        try
        {

            var Userid = await LocalStorage.GetItemAsync<string>("userId");

            Userid = Userid?.Trim('"', '\'');
            if (string.IsNullOrEmpty(Userid))
            {
                Navigation.NavigateTo("/Login");
                return;
            }
            var response = await Http.GetAsync($"https://localhost:7196/api/SubscribedPlan/{Userid}");
            if (response.IsSuccessStatusCode)
            {
                // Deserialize only if it's successful
                suscribedPlans = await response.Content.ReadFromJsonAsync<SuscribedPlanDTO>();
                await LoadPlatformsForSubscribedPlan();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // No subscribed plan found → just fetch all plans
                suscribedPlans = null;
                plans = await Http.GetFromJsonAsync<List<PlanDTO>>("https://localhost:7196/api/Plans");
                if (plans != null)
                    await LoadPlatformsForPlans();
            }
            else
            {
                Console.WriteLine($"Unexpected API error: {response.StatusCode}");
            }
            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading plans: {ex.Message}");
            plans = new List<PlanDTO>();
        }
    }

    private void SelectPlan(PlanDTO plan)
    {
        selectedPlan = plan;
    }

    private void CancelSelection()
    {
        selectedPlan = null;
    }

    private void ConfirmSelection()
    {
        
        Navigation.NavigateTo($"/Payment/{selectedPlan.PlansDomainId}");
    }
    private async Task LoadPlatformsForPlans()
    {
        foreach (var plan in plans)
        {
            if (string.IsNullOrEmpty(plan.PlatformIds)) continue;

            var platformIds = System.Text.Json.JsonSerializer.Deserialize<List<Guid>>(plan.PlatformIds);

            plan.Platforms = new List<PlatformDTO>();

            foreach (var id in platformIds)
            {
                try
                {
                    var platform = await Http.GetFromJsonAsync<PlatformDTO>($"https://localhost:7196/api/Platform/{id}");
                    if (platform != null)
                        plan.Platforms.Add(platform);
                }
                catch
                {
                    Console.WriteLine($"Failed to fetch platform {id}");
                }
            }
        }
    }

    private async Task LoadPlatformsForSubscribedPlan()
    {
        try
        {
            if (suscribedPlans == null || suscribedPlans.PlansDomainId == Guid.Empty)
                return;

            // Step 1️⃣: Get the Plan details using the PlanDomainId
            var plan = await Http.GetFromJsonAsync<PlanDTO>($"https://localhost:7196/api/Plans/{suscribedPlans.PlansDomainId}");
            if (plan == null || string.IsNullOrEmpty(plan.PlatformIds))
                return;

            // Step 2️⃣: Deserialize Platform IDs from the Plan
            var platformIds = System.Text.Json.JsonSerializer.Deserialize<List<Guid>>(plan.PlatformIds);
            if (platformIds == null || !platformIds.Any())
                return;

            // Step 3️⃣: Fetch each Platform detail using its ID
            suscribedPlans.Platforms = new List<PlatformDTO>();

            foreach (var id in platformIds)
            {
                try
                {
                    var platform = await Http.GetFromJsonAsync<PlatformDTO>($"https://localhost:7196/api/Platform/{id}");
                    if (platform != null)
                        suscribedPlans.Platforms.Add(platform);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to fetch platform {id}: {ex.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading subscribed plan platforms: {ex.Message}");
        }
    }

    private async Task PurchaseNewPlan()
    {
        try
        {
            // Clear existing subscribed plan (so UI shows available plans)
            suscribedPlans = null;

            // Fetch available plans from API
            plans = await Http.GetFromJsonAsync<List<PlanDTO>>("https://localhost:7196/api/Plans");

            if (plans != null)
                await LoadPlatformsForPlans();

            StateHasChanged(); // Refresh UI
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading plans for new purchase: {ex.Message}");
        }
    }


}
